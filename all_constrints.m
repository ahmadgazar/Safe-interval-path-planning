%% This code kills fascists

clc
clear all

col = 1;
rowin = 1;
roweq = 1;
cs = @(s1,s2)strcmp(s1,s2);

V = {'1','2','3','4','5','6'};
% V = {'1','2','3','4','5','6','7','8','9','10','11','12', ...
%     '13','14','15','16','17','18','19','20','21','22', ...
%     '23','24','25','26','27','28','29','30'};

%% Define E
tuples = { ...
    { 'e11' '1' '1' 1 }, ...
    { 'e12' '1' '2' 1 }, ...
    { 'e21' '2' '1' 1 }, ...
    { 'e22' '2' '2' 1 }, ...
    { 'e23' '2' '3' 1 }, ...
    { 'e24' '2' '4' 1 }, ...
    { 'e32' '3' '2' 1 }, ...
    { 'e33' '3' '3' 1 }, ...
    { 'e31' '3' '1' 1 }, ...
    { 'e42' '4' '2' 1 }, ...
    { 'e44' '4' '4' 1 }, ...
    { 'e45' '4' '5' 1 }, ...
    { 'e46' '4' '6' 1 }, ...
    { 'e54' '5' '4' 1 }, ...
    { 'e55' '5' '5' 1 }, ...
    { 'e64' '6' '4' 1 }, ...
    { 'e66' '6' '6' 1 }};

% tuples = { ...
%     { 'e11_1' '1' '9' 1 }, ...
%     { 'e12_1' '1' '8' 1 }, ...
%     { 'e21_1' '2' '7' 1 }, ...
%     { 'e22_1' '2' '8' 1 }, ...
%     { 'e23_1' '2' '9' 1 }, ...
%     { 'e24_1' '2' '10' 1 }, ...
%     { 'e33_1' '3' '9' 1 }, ...
%     { 'e32_1' '3' '8' 1 }, ...
%     { 'e42_1' '4' '8' 1 }, ...
%     { 'e44_1' '4' '10' 1 }, ...
%     { 'e45_1' '4' '11' 1 }, ...
%     { 'e46_1' '4' '12' 1 }, ...
%     { 'e55_1' '5' '11' 1 }, ...
%     { 'e54_1' '5' '10' 1 }, ...
%     { 'e64_1' '6' '10' 1 }, ...
%     { 'e66_1' '6' '12' 1 }, ... 
%     { 'e11_2' '7' '13' 1 }, ...
%     { 'e12_2' '7' '14' 1 }, ...
%     { 'e21_2' '8' '13' 1 }, ...
%     { 'e22_2' '8' '14' 1 }, ...
%     { 'e23_2' '8' '15' 1 }, ...
%     { 'e24_2' '8' '16' 1 }, ...
%     { 'e33_2' '9' '15' 1 }, ...
%     { 'e32_2' '9' '14' 1 }, ...
%     { 'e42_2' '10' '14' 1 }, ...
%     { 'e44_2' '10' '16' 1 }, ...
%     { 'e45_2' '10' '17' 1 }, ...
%     { 'e46_2' '10' '18' 1 }, ...
%     { 'e55_2' '11' '17' 1 }, ...
%     { 'e54_2' '11' '16' 1 }, ...
%     { 'e64_2' '12' '16' 1 }, ...
%     { 'e66_2' '12' '18' 1 }, ... 
%     { 'e11_3' '13' '19' 1 }, ...
%     { 'e12_3' '13' '20' 1 }, ...
%     { 'e21_3' '14' '19' 1 }, ...
%     { 'e22_3' '14' '20' 1 }, ...
%     { 'e23_3' '14' '21' 1 }, ...
%     { 'e24_3' '14' '22' 1 }, ...
%     { 'e33_3' '15' '21' 1 }, ...
%     { 'e32_3' '15' '20' 1 }, ...
%     { 'e42_3' '16' '20' 1 }, ...
%     { 'e44_3' '16' '22' 1 }, ...
%     { 'e45_3' '16' '23' 1 }, ...
%     { 'e46_3' '16' '24' 1 }, ...
%     { 'e55_3' '17' '23' 1 }, ...
%     { 'e54_3' '17' '22' 1 }, ...
%     { 'e64_3' '18' '22' 1 }, ...
%     { 'e66_3' '18' '24' 1 }, ...
%     { 'e11_4' '19' '25' 1 }, ...
%     { 'e12_4' '19' '26' 1 }, ...
%     { 'e21_4' '20' '25' 1 }, ...
%     { 'e22_4' '20' '26' 1 }, ...
%     { 'e23_4' '20' '27' 1 }, ...
%     { 'e24_4' '20' '28' 1 }, ...
%     { 'e33_4' '21' '27' 1 }, ...
%     { 'e32_4' '21' '26' 1 }, ...
%     { 'e42_4' '22' '26' 1 }, ...
%     { 'e44_4' '22' '28' 1 }, ...
%     { 'e45_4' '22' '29' 1 }, ...
%     { 'e46_4' '22' '30' 1 }, ...
%     { 'e55_4' '23' '29' 1 }, ...
%     { 'e54_4' '23' '28' 1 }, ...
%     { 'e64_4' '24' '28' 1 }, ...
%     { 'e66_4' '24' '30' 1 }};


E = {};

for tuple=tuples
    e = tuple{1}{1};
    E{end+1} = e;
    E_s.(e) = tuple{1}{2};
    E_t.(e) = tuple{1}{3};
    E_c.(e) = tuple{1}{4};
end
E
%% Define K

tuples = { 
    { 'k0' '1' '3'},... 
    { 'k1' '4' '6'} };  %% demand is vague!
K = {};
for tuple=tuples
    k = tuple{1}{1};
    K{end+1} = k;
    K_s.(k) = tuple{1}{2};
    K_t.(k) = tuple{1}{3};
%     K_d.(k) = tuple{1}{4};
end
K

% Define the flows with their constraints.
for k=K
    for e=E
        f.(k{1}).(e{1}) = col;   % why
        bu(col) = Inf;
        bl(col) = 0;
        col = col+1;
    end
end
f
%% Define the conservation constraint. 


for v=V
%for w = V
    for k=K
        s = K_s.(k{1});
        t = K_t.(k{1});
%         d = K_d.(k{1});
            for e=E
                if cs(E_s.(e{1}),v{1})
%                     i =  str2double(e{1});
%                     j =  str2double(k{1});
                    Aeq(roweq,f.(k{1}).(e{1})) = -1;
                end
                if cs(E_t.(e{1}),v{1}) 
                    Aeq(roweq,f.(k{1}).(e{1})) = 1;
                end
            end
            beq(roweq) = 0;
            roweq = roweq+1;
    %end
    end     
end


% for k=K
%     s = K_s.(k{1});
%     t = K_t.(k{1});
% %     d = K_d.(k{1});
%     for v=V
%         for w=V
%             for e=E
%                 if ( cs(E_s.(e{1}),v{1}) && cs(E_t.(e{1}),w{1}) )
%                     Aeq(roweq,f.(k{1}).(e{1})) = 1;
%                 end
%                 if ( cs(E_s.(e{1}),w{1}) && cs(E_t.(e{1}),v{1}) )
%                     Aeq(roweq,f.(k{1}).(e{1})) = -1;
%                 end
%             end
%         end
% %         if ( ~cs(v{1},s) && ~cs(v{1},t) )
%             beq(roweq) = 0;
% %         elseif ( v{1}==s )
% %             beq(roweq) = d;
% %         elseif ( v{1}==t )
% %             beq(roweq) = -d;
% %         end
%         roweq = roweq+1;
%     end
% end
%% Adding the 2 indp equations for condition number 9 in the paper
       for i = 1:length(K)
           for j = 1:length(K)
                 if i~=j
                   Aeq(roweq,i) = 1; 
                   beq(roweq) = 0;
                   roweq = roweq+1;
                 end
           end
       end

%% reset 
col = 1;
rowin = 1;

%% capacity constrints
for e=E
    for k=K
        Ain(rowin,f.(k{1}).(e{1})) = col;
    end
    bin(rowin) = 1; 
    rowin = rowin+1;
end

%% Define the objective function.
n = length(E);
[m,n1] = size(Ain);
o = zeros(1,n1);
o(1) = -1;
inc = length(E)+1;
index = 1;
for i = 1:(length(K)-1)
    o(index+inc) = -1;
    index = index+inc;
end
o;
%% Define the necessary objective variable with its constraint.
z = col;

%% Optimized with MATLAB's linprog.
% intcon = [1:36];
[ x, fval, exitflag, output ] = ...
    linprog( o,Ain, bin, Aeq, beq, bl,bu );

%% Display the results.

Variables = {};
Variables{z} = 'z';
for k=K
    for e=E
        Variables{f.(k{1}).(e{1})} = ['f_',k{1},e{1}];
    end
end
T = table;
T.Variables = Variables';
T.Values = x;